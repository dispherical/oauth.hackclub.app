<!DOCTYPE html>
<html>
  <head>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/water.css@2/out/water.css"
/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
  </head>

  <body>
    <h1>Login with Nest</h1>
    <h2>Continue to login with {{ name }}?</h2>
    <p>They'll be able to:</p>
    <ul>
      {% for scope in scopes %}
        {% if scope == "profile" %}
          <li>View your username, user ID, and the groups you are in</li>
        {% endif %}
        {% if scope == "email" %}
          <li>View your real, non-hackclub.app email</li>
        {% endif %}
      {% endfor %}

    </ul>
    <p>
      <b>{{ developer.name }}</b> provided this description: {{ description }}
    </p>
    <h2>Details about the developer:</h2>
    <p>
      The developer, <b>{{ developer.name }}</b>, has an account on nest with
      the username <b>{{ developer.account }}</b>.
      <a href="{{ developer.website }}">Visit their website</a>.
    </p>
    <p>
      {% if privacyPolicy %}The developer has also provided a privacy policy. <a href="{{ privacyPolicy }}">You may view it here.</a>
      {% endif %}
    </p>
    <h2>Authorize</h2>
    <p>
      To authorize, you must provide your Nest credentials below. It will be
      checked against PAM.
    </p>
    <label for="username">Username</label>
    <form id="form" action="/oauth2/validate" method="POST">
      <input
        type="username"
        name="username"
        id="username"
        placeholder="username"
/>
      <label for="password">Password</label>
      <input
        type="password"
        name="password"
        id="password"
        placeholder="●●●●●●●●●●"
/>
      <input
        type="hidden"
        name="state"
        id="state"
        placeholder=""
        value="{{ state }}"
        hidden="true"
/>
      <input
        type="hidden"
        name="redirect_uri"
        id="redirect_uri"
        placeholder=""
        value="{{ redirectURI }}"
        hidden="true"
/>
      <input
        type="hidden"
        name="client_id"
        id="client_id"
        placeholder=""
        value="{{ client_id }}"
        hidden="true"
/>
      <input
        type="hidden"
        name="scope"
        id="scope"
        placeholder=""
        value="{{ scope }}"
        hidden="true"
/>
      <button type="submit">Authorize</button>

      <br>
      <h2>Or, you can use Passwordless Authorization</h2>
      <p>
        To verify your identity, connect via SSH to the provided port. After connecting, you will be automatically redirected.<br>
        <b>Instructions:</b><br>
        1. Copy the SSH command below and run it in your terminal.<br>
        <code>ssh -o StrictHostKeyChecking=no hackclub.app -p {{ ssh_port }}</code><br>
        2. Leave this page open. You will be redirected automatically once verified.<br>
      </p>
      <input
        type="hidden"
        name="auth_code"
        id="auth_code"
        value="{{ auth_code }}"
/>
      <script>
        function pollSSHStatus() {
          const authCode = document
            .getElementById('auth_code')
            .value;
          if (!authCode) 
            return setTimeout(pollSSHStatus, 2000);
          fetch('/oauth2/ssh-status/' + authCode)
            .then(res => res.json())
            .then(data => {
              if (data.verified) {
                document
                  .getElementById('form')
                  .submit();
              } else {
                setTimeout(pollSSHStatus, 2000);
              }
            });
        }
        pollSSHStatus();
      </script>
    </form>
  </body>
</html>
